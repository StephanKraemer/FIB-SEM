function WriteMRCMode(map,rez,mode,filename)%% -----------------------------------------------------------------------%%   Write out a 2D image or a 3D volume as an MRC map file, for example%   for viewing in Chimera.  'map' is the 3D array, rez is the voxel%   size in angstroms.%%   fixed for 2D output as well.  fs 28 Aug 07% %   % Test program: create an ellipsoid and store it as a map file.%   [x y z]=ndgrid(-32:31);%   m=(x.^2+(y*1.5).^2+z.^2)>20^2;%   WriteMRC(m,1,'maptest.mrc');%%% SK        Allow to save images either as int8, int16 or real, depending%           on class of original data, desired precision or to simple save%           a series of images for inspection (int8, for example to cross%           check fiducial marker positions)%%% !!!       Make sure that the data range of map conforms to the desired%           output mode %% SYNTAX    WriteMRCMode(map,rez,mode,filename)%% INPUT     map         image series%           rez         voxel size in angstrom%           mode        data class%                       0    8 bit integer signed (-128 -> 127)%                       1   16 bit integer signed (-32768 -> 32767)%                       2   32 bit real signed (single)%                       3   16 bit integer complex%                       4   32 bit real complex%                       6   16 bit integer unsigned (0 -%           filename    ...%% -----------------------------------------------------------------------f=WriteMRCHeaderMode(map,rez,mode,filename);% output classswitch mode    case 0        oclass = 'int8';    case 1        oclass = 'int16';    case 2        oclass = 'single';    case 3        error('Complex numbers not yet integrated')    case 4        error('Complex numbers not yet integrated')    case 6        oclass = 'uint16';    otherwise        error('Unknown output class')end% CAREFUL:  Dynamic range is NOT checked here, it needs to be adjusted%           outside of this function!count2 = fwrite(f,map,oclass);fclose(f);return;